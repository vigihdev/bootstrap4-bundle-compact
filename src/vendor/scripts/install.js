#!/usr/bin/env node

const fs = require('fs');
const path = require('path');

// FIX PENTING: ambil root project
const ROOT = process.env.npm_config_local_prefix;
const dstPath = path.resolve(ROOT, 'node_modules', '@vigihdev', 'bootstrap4-bundle-compact', 'src', 'assets', 'parent-themes-styles');
const dstFilePath = path.join(dstPath, '_index.scss');
const srcPath = path.resolve(ROOT, 'node_modules', 'bootstrap', 'scss');

function pathValidate(filepath) {
    return filepath && fs.existsSync(filepath)
}

const isNotValids = [dstPath, dstFilePath, srcPath].filter(p => !pathValidate(p))
if (isNotValids.length === 0) {

    const relativePath = path.relative(dstPath, srcPath);

    const content = [
        '// index.scss',
        '',
        '// Generated by Command',
        `// Timestamp: ${new Date().toISOString()}`,
        '',
        `@import "${relativePath}/mixins";`,
        `@import "${relativePath}/functions";`,
        `@import "${relativePath}/variables";`,
        ''
    ].join('\n');

    fs.writeFileSync(dstFilePath, content, 'utf8');
    console.log(`✅ File berhasil disimpan: ${dstFilePath}`);
}

// Hapus deprecated size()
const fileSizeScss = path.resolve(
    ROOT,
    'node_modules',
    'bootstrap',
    'scss',
    'mixins',
    '_size.scss'
);

if (fs.existsSync(fileSizeScss)) {
    let content = fs.readFileSync(fileSizeScss, 'utf8');

    const regex = /@include deprecate\("`size\(\)`", "v4\.3\.0", "v5"\);\s*/g;
    const newContent = content.replace(regex, '');

    if (content !== newContent) {
        fs.writeFileSync(fileSizeScss, newContent, 'utf8');
        console.log(`✅ Updated: ${fileSizeScss}`);
    }
}
